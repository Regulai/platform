{% extends 'base.html' %}
{% load static %}

{% block title %}Prompt #{{ prompt.id }}{% endblock %}

{% block content %}
<div class="row">
  <!-- Back button and header -->
  <div class="col-12 mb-4">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a href="{% url 'front:prompts_list' %}" class="btn btn-outline-primary">
          <iconify-icon icon="solar:arrow-left-linear"></iconify-icon>
          Back to Prompts
        </a>
        <h4 class="mb-0 fw-semibold">
          <iconify-icon icon="solar:chat-round-dots-bold" class="text-primary me-2"></iconify-icon>
          Prompt #{{ prompt.id }}
        </h4>
      </div>
      <div>
        {% if prompt.filtered %}
        <span class="badge bg-danger fs-4 px-3 py-2">
          <iconify-icon icon="solar:danger-triangle-bold" class="me-1"></iconify-icon>
          Detected
        </span>
        {% else %}
        <span class="badge bg-success fs-4 px-3 py-2">
          <iconify-icon icon="solar:check-circle-bold" class="me-1"></iconify-icon>
          Clean
        </span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Prompt Information -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          <iconify-icon icon="solar:info-circle-line-duotone" class="text-primary me-2"></iconify-icon>
          Details
        </h5>

        <div class="mb-3">
          <label class="text-muted small">User</label>
          <div class="d-flex align-items-center gap-2 mt-1">
            <iconify-icon icon="solar:user-circle-bold" class="fs-6 text-primary"></iconify-icon>
            <span class="fw-semibold">{{ prompt.user.username }}</span>
          </div>
        </div>

        <div class="mb-3">
          <label class="text-muted small">Model Used</label>
          <div class="mt-1">
            <span class="badge bg-primary-subtle text-primary fs-3">{{ prompt.model_used }}</span>
          </div>
        </div>

        <div class="mb-3">
          <label class="text-muted small">Status</label>
          <div class="mt-1">
            {% if prompt.filtered %}
            <span class="badge bg-danger fs-3">
              <iconify-icon icon="solar:danger-triangle-bold" class="me-1"></iconify-icon>
              Detected by Rules
            </span>
            {% else %}
            <span class="badge bg-success fs-3">
              <iconify-icon icon="solar:check-circle-bold" class="me-1"></iconify-icon>
              Clean
            </span>
            {% endif %}
          </div>
        </div>

        <div class="mb-3">
          <label class="text-muted small">Date</label>
          <div class="mt-1">
            <iconify-icon icon="solar:calendar-bold" class="text-muted me-1"></iconify-icon>
            {{ prompt.created_at|date:"F d, Y" }}
          </div>
          <div class="mt-1">
            <iconify-icon icon="solar:clock-circle-bold" class="text-muted me-1"></iconify-icon>
            {{ prompt.created_at|date:"H:i:s" }}
          </div>
        </div>

        {% if response %}
        <div class="mb-3">
          <label class="text-muted small">Tokens Used</label>
          <div class="mt-1">
            <span class="badge bg-info-subtle text-info fs-3">{{ response.tokens_used }} tokens</span>
          </div>
        </div>
        {% endif %}

        {% if prompt.file_name %}
        <div class="mb-0">
          <label class="text-muted small">Attached File</label>
          <div class="mt-1">
            <iconify-icon icon="solar:file-bold" class="text-primary me-1"></iconify-icon>
            <span class="fw-semibold">{{ prompt.file_name }}</span>
          </div>
          {% if prompt.file_size %}
          <div class="mt-1 text-muted small">
            Size: {{ prompt.file_size|filesizeformat }}
          </div>
          {% endif %}
          {% if prompt.file_md5 %}
          <div class="mt-2">
            <small class="text-muted d-block"><strong>MD5:</strong></small>
            <code class="small">{{ prompt.file_md5 }}</code>
          </div>
          {% endif %}
          {% if prompt.file_sha1 %}
          <div class="mt-1">
            <small class="text-muted d-block"><strong>SHA1:</strong></small>
            <code class="small">{{ prompt.file_sha1 }}</code>
          </div>
          {% endif %}
          {% if prompt.file_sha256 %}
          <div class="mt-1">
            <small class="text-muted d-block"><strong>SHA256:</strong></small>
            <code class="small">{{ prompt.file_sha256 }}</code>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Alerts Generated -->
    {% if alerts %}
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          <iconify-icon icon="solar:bell-bing-line-duotone" class="text-danger me-2"></iconify-icon>
          Alerts Generated ({{ alerts|length }})
        </h5>

        {% for alert in alerts %}
        <a href="{% url 'front:alert_detail' alert.pk %}" class="d-flex align-items-center gap-2 p-2 mb-2 rounded-2 text-decoration-none
          {% if alert.severity == 'critical' %}bg-danger-subtle{% elif alert.severity == 'high' %}bg-warning-subtle{% elif alert.severity == 'medium' %}bg-info-subtle{% else %}bg-secondary-subtle{% endif %}">
          <div class="rounded-circle d-flex align-items-center justify-content-center
            {% if alert.severity == 'critical' %}bg-danger{% elif alert.severity == 'high' %}bg-warning{% elif alert.severity == 'medium' %}bg-info{% else %}bg-secondary{% endif %}"
            style="width: 32px; height: 32px;">
            <iconify-icon icon="solar:bell-bing-bold" class="{% if alert.severity == 'critical' or alert.severity == 'medium' %}text-white{% else %}text-dark{% endif %}"></iconify-icon>
          </div>
          <div class="flex-grow-1">
            <div class="fw-semibold text-dark">{{ alert.rule.name|default:"Alert" }}</div>
            <small class="text-muted">{{ alert.severity|title }}</small>
          </div>
          {% if alert.resolved %}
          <span class="badge bg-success">Resolved</span>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Prompt Content and Response -->
  <div class="col-lg-8">
    <!-- Prompt Content -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          <iconify-icon icon="solar:chat-round-dots-line-duotone" class="text-primary me-2"></iconify-icon>
          Prompt Content
        </h5>

        <div class="bg-light rounded-3 p-4">
          <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit;">{{ prompt.content }}</pre>
        </div>
      </div>
    </div>

    <!-- Response Content -->
    {% if response %}
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          <iconify-icon icon="solar:cpu-bolt-line-duotone" class="text-success me-2"></iconify-icon>
          AI Response
        </h5>

        <div class="bg-success-subtle rounded-3 p-4">
          <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit;">{{ response.content }}</pre>
        </div>

        <div class="mt-3 text-muted small">
          <iconify-icon icon="solar:clock-circle-bold" class="me-1"></iconify-icon>
          Response received at {{ response.created_at|date:"F d, Y H:i:s" }}
        </div>
      </div>
    </div>
    {% else %}
    <div class="card">
      <div class="card-body text-center py-5">
        <iconify-icon icon="solar:cpu-bolt-line-duotone" class="text-muted" style="font-size: 3rem;"></iconify-icon>
        <p class="mt-3 mb-0 text-muted">No response recorded for this prompt.</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
