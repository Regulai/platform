{% extends 'base.html' %}
{% load static %}

{% block title %}{% if rule %}Edit Rule{% else %}New Rule{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .yara-editor {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    background-color: #1e293b;
    color: #e2e8f0;
    border: none;
    border-radius: 8px;
    padding: 1rem;
  }
  .yara-editor:focus {
    background-color: #1e293b;
    color: #e2e8f0;
    box-shadow: 0 0 0 0.25rem rgba(99, 91, 255, 0.25);
  }
  .alert-error-soft {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
  }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'front:rules_list' %}">Rules</a></li>
        {% if rule %}
        <li class="breadcrumb-item"><a href="{% url 'front:rule_detail' rule.pk %}">{{ rule.name }}</a></li>
        <li class="breadcrumb-item active">Edit</li>
        {% else %}
        <li class="breadcrumb-item active">New Rule</li>
        {% endif %}
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          <iconify-icon icon="{% if rule %}solar:pen-bold{% else %}solar:add-circle-bold{% endif %}" class="text-primary me-2"></iconify-icon>
          {% if rule %}Edit Rule{% else %}Create New Rule{% endif %}
        </h5>

        <!-- Messages -->
        {% if messages %}
        {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-error-soft{% else %}alert-{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
          <iconify-icon icon="{% if message.tags == 'error' %}solar:danger-triangle-bold{% elif message.tags == 'success' %}solar:check-circle-bold{% else %}solar:info-circle-bold{% endif %}" class="me-2"></iconify-icon>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        <form method="post">
          {% csrf_token %}

          <div class="mb-4">
            <label for="name" class="form-label fw-semibold">Rule Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="name" name="name"
                   value="{% if rule %}{{ rule.name }}{% elif form_data %}{{ form_data.name }}{% endif %}"
                   placeholder="e.g., detect_pii_leak" required>
            <div class="form-text">A unique identifier for this rule.</div>
          </div>

          <div class="mb-4">
            <label for="description" class="form-label fw-semibold">Description</label>
            <textarea class="form-control" id="description" name="description" rows="2"
                      placeholder="Describe what this rule detects...">{% if rule %}{{ rule.description }}{% elif form_data %}{{ form_data.description }}{% endif %}</textarea>
          </div>

          <div class="mb-4">
            <label for="rules_group" class="form-label fw-semibold">Rules Group <span class="text-danger">*</span></label>
            <select class="form-select" id="rules_group" name="rules_group" required>
              <option value="">Select a group...</option>
              {% for group in rules_groups %}
              <option value="{{ group.id }}"
                      {% if rule and rule.rules_group_id == group.id %}selected{% endif %}
                      {% if form_data and form_data.rules_group == group.id|stringformat:"s" %}selected{% endif %}>
                {{ group.name }}
                {% if group.company %}({{ group.company.name }}){% endif %}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <label for="severity" class="form-label fw-semibold">Severity <span class="text-danger">*</span></label>
              <select class="form-select" id="severity" name="severity" required>
                <option value="low" {% if rule and rule.severity == 'low' %}selected{% endif %}
                        {% if form_data and form_data.severity == 'low' %}selected{% endif %}>
                  Low
                </option>
                <option value="medium" {% if rule and rule.severity == 'medium' %}selected{% endif %}
                        {% if form_data and form_data.severity == 'medium' %}selected{% endif %}
                        {% if not rule and not form_data %}selected{% endif %}>
                  Medium
                </option>
                <option value="high" {% if rule and rule.severity == 'high' %}selected{% endif %}
                        {% if form_data and form_data.severity == 'high' %}selected{% endif %}>
                  High
                </option>
                <option value="critical" {% if rule and rule.severity == 'critical' %}selected{% endif %}
                        {% if form_data and form_data.severity == 'critical' %}selected{% endif %}>
                  Critical
                </option>
              </select>
              <div class="form-text">Severity level for alerts generated by this rule.</div>
            </div>

            <div class="col-md-6 mb-4">
              <label for="applies_to" class="form-label fw-semibold">Applies To <span class="text-danger">*</span></label>
              <select class="form-select" id="applies_to" name="applies_to" required>
                <option value="both" {% if rule and rule.applies_to == 'both' %}selected{% endif %}
                        {% if form_data and form_data.applies_to == 'both' %}selected{% endif %}
                        {% if not rule and not form_data %}selected{% endif %}>
                  <iconify-icon icon="solar:layers-bold"></iconify-icon> Both (Prompts & Files)
                </option>
                <option value="prompts" {% if rule and rule.applies_to == 'prompts' %}selected{% endif %}
                        {% if form_data and form_data.applies_to == 'prompts' %}selected{% endif %}>
                  Prompts Only
                </option>
                <option value="files" {% if rule and rule.applies_to == 'files' %}selected{% endif %}
                        {% if form_data and form_data.applies_to == 'files' %}selected{% endif %}>
                  Files Only
                </option>
              </select>
              <div class="form-text">Choose what this rule should scan.</div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <label for="action" class="form-label fw-semibold">Action <span class="text-danger">*</span></label>
              <select class="form-select" id="action" name="action" required>
                <option value="block" {% if rule and rule.action == 'block' %}selected{% endif %}
                        {% if form_data and form_data.action == 'block' %}selected{% endif %}
                        {% if not rule and not form_data %}selected{% endif %}>
                  Block
                </option>
                <option value="consent" {% if rule and rule.action == 'consent' %}selected{% endif %}
                        {% if form_data and form_data.action == 'consent' %}selected{% endif %}>
                  Consent
                </option>
              </select>
              <div class="form-text">
                <strong>Block</strong> prevents the message from being sent.
                <strong>Consent</strong> asks the user for confirmation before sending.
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label for="yara_rule" class="form-label fw-semibold">YARA Rule <span class="text-danger">*</span></label>
            <textarea class="form-control yara-editor" id="yara_rule" name="yara_rule" rows="14"
                      placeholder="rule example_rule {
    meta:
        description = &quot;Example rule&quot;
        author = &quot;Your Name&quot;

    strings:
        $pattern = &quot;sensitive_data&quot; nocase

    condition:
        $pattern
}" required>{% if rule %}{{ rule.yara_rule }}{% elif form_data %}{{ form_data.yara_rule }}{% endif %}</textarea>
            <div class="form-text">
              Write your YARA rule here. The syntax will be validated before saving.
              <br>
              <br>
              <a href="https://yara.readthedocs.io/en/stable/writingrules.html" target="_blank" class="text-primary">
                YARA Documentation <iconify-icon icon="solar:arrow-right-up-linear"></iconify-icon>
              </a>
            </div>
          </div>

          <div class="mb-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="active" name="active"
                     {% if rule and rule.active %}checked{% elif not rule %}checked{% endif %}>
              <label class="form-check-label fw-semibold" for="active">Active</label>
            </div>
            <div class="form-text">Active rules will be used to validate prompts.</div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <iconify-icon icon="solar:diskette-bold" class="me-1"></iconify-icon>
              {% if rule %}Save Changes{% else %}Create Rule{% endif %}
            </button>
            <a href="{% if rule %}{% url 'front:rule_detail' rule.pk %}{% else %}{% url 'front:rules_list' %}{% endif %}" class="btn btn-outline-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sidebar Help -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-3">
          <iconify-icon icon="solar:question-circle-bold" class="text-primary me-2"></iconify-icon>
          YARA Quick Reference
        </h5>
        <div class="mb-3">
          <h6 class="fw-semibold text-muted">Basic Structure</h6>
          <pre class="bg-light p-2 rounded small mb-0">rule rule_name {
    strings:
        $s1 = "text"
    condition:
        $s1
}</pre>
        </div>
        <div class="mb-3">
          <h6 class="fw-semibold text-muted">String Modifiers</h6>
          <ul class="small mb-0">
            <li><code>nocase</code> - Case insensitive</li>
            <li><code>wide</code> - Unicode strings</li>
            <li><code>ascii</code> - ASCII strings</li>
            <li><code>fullword</code> - Full word match</li>
          </ul>
        </div>
        <div class="mb-3">
          <h6 class="fw-semibold text-muted">Conditions</h6>
          <ul class="small mb-0">
            <li><code>any of them</code> - Any string matches</li>
            <li><code>all of them</code> - All strings match</li>
            <li><code>2 of ($s*)</code> - 2 of strings starting with $s</li>
          </ul>
        </div>
        <div class="mb-3">
          <h6 class="fw-semibold text-muted">
            <iconify-icon icon="solar:eye-closed-bold" class="text-warning"></iconify-icon>
          </h6>
          <p class="small mb-2">
          </p>
          <ul class="small mb-2">
          </ul>
          <div class="alert alert-info-subtle small mb-0">
            <iconify-icon icon="solar:info-circle-bold" class="me-1"></iconify-icon>
            <strong>Note:</strong> Alerts are created when matched, regardless of user confirmation.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
